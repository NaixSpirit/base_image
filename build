#!/bin/sh
set -e

TAG_POSTFIX="fishtrip"
CURRENT_PATH=`pwd`
ONLINE_REMOTE_URL="registry-internal.cn-beijing.aliyuncs.com/fishtrip"
ONLINE_SOURCES_LIST_FILE="./aliyun.sources.list.online"
LOCAL_REMOTE_URL="registry.cn-beijing.aliyuncs.com/fishtrip"
LOCAL_SOURCES_LIST_FILE="./aliyun.sources.list.local"
DEFAULT_MAINTAINER="hxy <huangxuanyu@fishtrip.cn>"

for i in "$@"
do
case $i in
    -l=*|--language=*)
    LANGUAGE="${i#*=}"
    shift
    ;;
    -v=*|--version=*)
    VERSION="${i#*=}"
    shift
    ;;
    -o=*|--online=*)
    ONLINE="${i#*=}"
    shift
    ;;
    -m=*|--maintainer==*)
    MAINTAINER="${i#*=}"
    ;;
    -h|--help)
    echo 'Options:
  -v, --version         Set version
  -l, --language        Set language
  -o, --online          Set using online environment
  -m, --maintainer      Set maintainer'
    exit 0
    ;;
    --default)
    DEFAULT=YES
    shift
    ;;
    *)
    ;;
esac
done

DOCKERFILE=$CURRENT_PATH/$LANGUAGE/Dockerfile
if [[ ! -n $MAINTAINER ]] ; then
  MAINTAINER=$DEFAULT_MAINTAINER
fi
BUILD_TAG=${VERSION}-${TAG_POSTFIX}
if [[ -n $ONLINE ]] ; then
  cp $ONLINE_SOURCES_LIST_FILE $CURRENT_PATH/sources.list
  REMOTE_URL=$ONLINE_REMOTE_URL/$LANGUAGE
else
  cp $LOCAL_SOURCES_LIST_FILE $CURRENT_PATH/sources.list
  REMOTE_URL=$LOCAL_REMOTE_URL/$LANGUAGE
fi

echo "#### CHECK BUILD OPTIONS: ####\n"
echo "DOCKERFILE = ${DOCKERFILE}"
echo "LANGUAGE   = ${LANGUAGE}"
echo "VERSION    = ${VERSION}"
echo "BUILD_TAG  = ${BUILD_TAG}"
echo "MAINTAINER = ${MAINTAINER}"
echo "REMOTE_URL = ${REMOTE_URL}"
echo

if [[ ! -n $LANGUAGE ]] || [[ ! -n $VERSION ]]; then
  echo "WARNING: OPTIONS [--language] or [--version] can't be blank!!!"
  exit 1
fi

if [[ ! -f $DOCKERFILE ]]; then
  echo "WARNING: $DOCKERFILE not exist!!!"
  exit 1
fi

BUILD_COMMAND="docker build -t $LANGUAGE:$BUILD_TAG --build-arg VERSION=$VERSION --build-arg MAINTAINER='$MAINTAINER' -f $DOCKERFILE ."

echo "#### BUILD COMMAND: $BUILD_COMMAND\n"

eval $BUILD_COMMAND

rm -rf $CURRENT_PATH/sources.list

echo "#### START PUSH IMAGE TO REMOTE $REMOTE_URL\n"
docker tag $LANGUAGE:$BUILD_TAG $REMOTE_URL:$BUILD_TAG
docker push $REMOTE_URL:$BUILD_TAG
